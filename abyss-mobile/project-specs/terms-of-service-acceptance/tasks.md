# Implementation Plan

## Task List

- [ ] 1. Create ToS storage service module
  - Write `utils/tosStorage.ts` with AsyncStorage implementation
  - Define `ToSAcceptance` interface for type safety
  - Implement `getToSAcceptance()` function to retrieve stored acceptance state
  - Implement `storeToSAcceptance(version: string)` function to save acceptance with timestamp
  - Implement `hasAcceptedCurrentToS(currentVersion: string)` function to check acceptance validity
  - Add error handling for storage failures (log but don't throw)
  - Add error handling for corrupted data (treat as non-acceptance)
  - Write unit tests for all storage functions
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 7.2, 7.3_

- [ ] 2. Create ToS content constant
  - Write `constants/TermsOfServiceContent.ts` file
  - Define `ToSContent` interface with version, title, lastUpdated, and sections
  - Define `ToSSection` interface for section structure
  - Create `CURRENT_TOS` constant with version "1.0.0"
  - Write section 1: Acceptance of Terms
  - Write section 2: Entertainment Purpose Only (emphasize no real money)
  - Write section 3: Wallet Creation and Data Privacy (emphasize no personal data collection)
  - Write section 4: User Conduct
  - Write section 5: Limitation of Liability
  - Write section 6: Intellectual Property
  - Write section 7: Termination
  - Write section 8: Changes to Terms
  - Write section 9: Governing Law
  - Export `CURRENT_TOS` as default export
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 5.1_

- [ ] 3. Create ToS screen component UI structure
  - Create `app/terms-of-service.tsx` file
  - Import required React Native components (SafeAreaView, ScrollView, View, Text, TouchableOpacity)
  - Import theme from `constants/Theme`
  - Import `CURRENT_TOS` from `constants/TermsOfServiceContent`
  - Define component state for scroll tracking (`scrolledToBottom`)
  - Define component state for loading state
  - Create SafeAreaView container with black background
  - Create fixed header with "Terms of Service" title and version
  - Create ScrollView for content area
  - Map over `CURRENT_TOS.sections` to render each section heading and content
  - Create fixed footer container for buttons
  - Apply styling using StyleSheet following Theme constants
  - _Requirements: 1.4, 6.1, 6.2, 6.4_

- [ ] 4. Implement ToS screen scroll tracking and visual feedback
  - Add `onScroll` handler to ScrollView
  - Implement scroll position calculation to detect bottom
  - Update `scrolledToBottom` state based on scroll position
  - Add scroll indicator (gradient overlay) that fades when scrolled to bottom
  - Add conditional styling for scroll feedback
  - Test scroll behavior on different screen sizes
  - _Requirements: 6.3, 6.5_

- [ ] 5. Implement accept button functionality
  - Create `handleAccept` async function
  - Import `storeToSAcceptance` from `utils/tosStorage`
  - Import `useRouter` from `expo-router`
  - Set loading state to true when accept is tapped
  - Call `storeToSAcceptance(CURRENT_TOS.version)` in try/catch
  - On success, navigate to `/title` using `router.replace()`
  - On error, show error alert and keep user on ToS screen
  - Set loading state to false after completion
  - Disable accept button during loading state
  - Style accept button with primary orange color from Theme
  - _Requirements: 3.1, 3.2, 3.4, 7.2_

- [ ] 6. Implement decline button functionality
  - Create `handleDecline` function
  - Create decline confirmation modal state (`showDeclineModal`)
  - Import Modal component from React Native
  - Create modal UI with title "Terms of Service Required"
  - Add message explaining acceptance is required
  - Add "Review Terms" button that closes modal
  - Add "Close App" button that exits the app (using BackHandler)
  - Style decline button with white outline
  - Style modal with dark background and white text following Theme
  - _Requirements: 3.5, 3.6, 3.7_

- [ ] 7. Modify splash screen to add ToS navigation guard
  - Open `app/index.tsx` for editing
  - Import `hasAcceptedCurrentToS` from `utils/tosStorage`
  - Import `CURRENT_TOS` from `constants/TermsOfServiceContent`
  - Add state for ToS check completion (`tosCheckComplete`)
  - Create async function `checkToSAcceptance` to check acceptance state
  - Call `hasAcceptedCurrentToS(CURRENT_TOS.version)` in try/catch
  - Modify navigation logic in useEffect timeout
  - If ToS not accepted, call `router.replace('/terms-of-service')`
  - If ToS accepted, call `router.replace('/title')` as before
  - Ensure ToS check happens in parallel with account initialization
  - Add error handling for ToS check failures (default to showing ToS)
  - _Requirements: 1.1, 1.2, 1.3, 4.3, 4.4, 5.2, 5.3, 5.4_

- [ ] 8. Add ToS screen to navigation stack
  - Open `app/_layout.tsx` for editing
  - Add `<Stack.Screen name="terms-of-service" />` to Stack component
  - Ensure screen is added before "title" screen in stack order
  - Verify `headerShown: false` applies to ToS screen
  - Verify fade animation applies to ToS screen
  - _Requirements: 1.1_

- [ ] 9. Handle background/foreground app state during ToS flow
  - Add AppState listener to ToS screen component
  - Import AppState from React Native
  - Add useEffect to subscribe to AppState changes
  - Ensure scroll position persists when app is backgrounded and foregrounded
  - Test that user cannot bypass ToS by backgrounding the app
  - Clean up AppState subscription in useEffect cleanup
  - _Requirements: 7.4, 7.5_

- [ ] 10. Test complete ToS acceptance flow end-to-end
  - [ ] 10.1 Test first-time user flow
    - Clear AsyncStorage to simulate fresh install
    - Launch app and verify splash screen appears
    - Verify navigation to ToS screen after splash
    - Scroll through entire ToS content
    - Tap Accept button
    - Verify navigation to title screen
    - Verify acceptance stored in AsyncStorage
    - _Requirements: 1.1, 1.2, 3.1, 3.4, 4.1, 4.2_
  - [ ] 10.2 Test returning user flow
    - Close and relaunch app with existing acceptance
    - Verify splash screen appears
    - Verify direct navigation to title screen (ToS skipped)
    - Verify no ToS screen shown
    - _Requirements: 1.3, 4.3, 4.4_
  - [ ] 10.3 Test decline flow
    - Clear AsyncStorage to simulate fresh install
    - Launch app and navigate to ToS
    - Tap Decline button
    - Verify modal appears with correct message
    - Tap "Review Terms" and verify modal closes
    - Tap Decline again and tap "Close App"
    - Verify app closes
    - _Requirements: 3.5, 3.6, 3.7_
  - [ ] 10.4 Test version upgrade flow
    - Accept ToS version 1.0.0
    - Modify `CURRENT_TOS.version` to "1.1.0"
    - Relaunch app
    - Verify ToS screen appears again
    - Verify updated version shown
    - Accept new version
    - Verify acceptance stored with new version
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
  - [ ] 10.5 Test storage failure handling
    - Mock AsyncStorage to throw error on setItem
    - Navigate to ToS screen
    - Tap Accept button
    - Verify error alert appears
    - Verify user remains on ToS screen
    - Verify console error logged
    - _Requirements: 7.2_
  - [ ] 10.6 Test corrupted data handling
    - Manually write invalid JSON to AsyncStorage ToS key
    - Launch app
    - Verify ToS screen appears (treats as non-acceptance)
    - Accept ToS
    - Verify valid acceptance overwrites corrupted data
    - _Requirements: 7.3_
  - [ ] 10.7 Test scroll behavior and visual feedback
    - Navigate to ToS screen
    - Verify scroll indicator visible at bottom
    - Scroll halfway through content
    - Verify scroll indicator still visible
    - Scroll to bottom of content
    - Verify scroll indicator disappears
    - Verify accept button remains enabled throughout
    - _Requirements: 6.3, 6.5_
  - [ ] 10.8 Test UI styling and theme consistency
    - Navigate to ToS screen
    - Verify black background matches app theme
    - Verify text uses Pixelify Sans font
    - Verify headings and body text are readable
    - Verify accept button uses primary orange color
    - Verify decline button has white outline
    - Verify spacing follows theme constants
    - Test on different screen sizes (small and large phones)
    - _Requirements: 6.1, 6.2, 6.4_
  - [ ] 10.9 Test background/foreground handling
    - Navigate to ToS screen
    - Scroll to middle of content
    - Background the app
    - Foreground the app
    - Verify scroll position maintained
    - Verify still on ToS screen
    - Accept ToS and verify navigation works
    - _Requirements: 7.4, 7.5_

- [ ] 11. Accessibility improvements (optional enhancement)
  - Add accessibility labels to buttons
  - Add accessibility hints for scroll view
  - Test with screen reader (VoiceOver/TalkBack)
  - Ensure proper focus order for keyboard navigation
  - _Requirements: Future enhancement_

- [ ] 12. Code review and cleanup
  - Review all new code for consistency with project style
  - Remove any console.log statements used for debugging
  - Ensure all imports are organized
  - Verify TypeScript types are properly defined
  - Check for any unused imports or variables
  - Run linter (`npm run lint`) and fix any issues
  - _Requirements: All_
